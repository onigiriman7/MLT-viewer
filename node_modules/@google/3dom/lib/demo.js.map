{"version":3,"file":"demo.js","sourceRoot":"","sources":["../src/demo.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\nimport {ACESFilmicToneMapping, Mesh, MeshStandardMaterial, PerspectiveCamera, PMREMGenerator, Scene, sRGBEncoding, UnsignedByteType, WebGLRenderer} from 'three';\nimport {OrbitControls} from 'three/examples/jsm/controls/OrbitControls.js';\nimport {GLTF, GLTFLoader} from 'three/examples/jsm/loaders/GLTFLoader.js';\nimport {RGBELoader} from 'three/examples/jsm/loaders/RGBELoader.js';\nimport {RoughnessMipmapper} from 'three/examples/jsm/utils/RoughnessMipmapper.js';\n\n\nimport {ThreeDOMExecutionContext} from './context.js';\nimport {CorrelatedSceneGraph} from './facade/three-js/correlated-scene-graph.js';\nimport {ModelGraft} from './facade/three-js/model-graft.js';\n\nclass ThreeDOMDemo {\n  container = document.querySelector('#container')!;\n  camera = new PerspectiveCamera(\n      45, window.innerWidth / window.innerHeight, 0.25, 20);\n  scene = new Scene();\n  renderer = new WebGLRenderer({antialias: true});\n\n  pmremGenerator = new PMREMGenerator(this.renderer);\n\n  controls = new OrbitControls(this.camera, this.renderer.domElement);\n\n  textureLoader = new RGBELoader();\n  gltfLoader = new GLTFLoader();\n\n  constructor() {\n    this.camera.position.set(-1.8, 0.6, 2.7);\n\n    this.renderer.setPixelRatio(window.devicePixelRatio);\n    this.renderer.setSize(window.innerWidth, window.innerHeight);\n    this.renderer.toneMapping = ACESFilmicToneMapping;\n    this.renderer.toneMappingExposure = 0.8;\n    this.renderer.outputEncoding = sRGBEncoding;\n\n    this.container.appendChild(this.renderer.domElement);\n\n    this.pmremGenerator.compileEquirectangularShader();\n\n    this.controls.minDistance = 2;\n    this.controls.maxDistance = 10;\n    this.controls.target.set(0, 1, 0);\n    this.controls.update();\n\n    this.textureLoader.setDataType(UnsignedByteType)\n        .setPath('../shared-assets/environments/')\n        .load('lightroom_14b.hdr', (environmentTexture) => {\n          const environmentMap =\n              this.pmremGenerator.fromEquirectangular(environmentTexture)\n                  .texture;\n\n          this.scene.environment = environmentMap;\n\n          environmentTexture.dispose();\n          this.pmremGenerator.dispose();\n        });\n\n    this.gltfLoader.setPath('../shared-assets/models/');\n    this.gltfLoader.load('Astronaut.glb', (gltf) => {\n      const roughnessMipmapper = new RoughnessMipmapper(this.renderer);\n      gltf.scene.traverse((child) => {\n        if ((child as Mesh).isMesh && (child as Mesh).material &&\n            ((child as Mesh).material as MeshStandardMaterial).isMaterial) {\n          roughnessMipmapper.generateMipmaps(\n              (child as Mesh).material as MeshStandardMaterial);\n        }\n      });\n      roughnessMipmapper.dispose();\n\n      this.scene.add(gltf.scene);\n\n      this.activate3DOM(gltf);\n    });\n\n    window.addEventListener('resize', () => this.updateSize(), false);\n\n    this.render();\n  }\n\n  updateSize() {\n    this.camera.aspect = window.innerWidth / window.innerHeight;\n    this.camera.updateProjectionMatrix();\n    this.renderer.setSize(window.innerWidth, window.innerHeight);\n  }\n\n  render() {\n    this.renderer.render(this.scene, this.camera);\n\n    requestAnimationFrame(() => {\n      this.render();\n    });\n  }\n\n  activate3DOM(gltf: GLTF) {\n    const script = document.querySelector('script[type=\"3DOM\"]')!;\n    const scriptText = script.textContent!;\n\n    const context =\n        new ThreeDOMExecutionContext(['material-properties', 'messaging']);\n    const graft = new ModelGraft(\n        '../shared-assets/models/Astronaut.glb',\n        CorrelatedSceneGraph.from(gltf));\n\n    context.eval(scriptText);\n    context.changeModel(graft);\n\n    document.querySelector('#ui')!.addEventListener('click', (event) => {\n      const colorString = (event.target as HTMLElement).dataset.color;\n\n      if (!colorString) {\n        return;\n      }\n\n      const color = colorString.split(',').map(\n          (numberString) => parseFloat(numberString));\n\n      // Forward interaction details to the <model-viewer> worklet:\n      context.worker.postMessage({action: 'change-color', payload: color});\n    });\n\n    const dropZone =\n        document.querySelector('#base-color .dropzone') as HTMLDivElement;\n    const dropInputElement =\n        document.querySelector('#base-color .input') as HTMLInputElement;\n    const dropPreview =\n        document.querySelector('#base-color .preview') as HTMLDivElement;\n\n\n    const dropControl =\n        new (self as any)\n            .SimpleDropzone.SimpleDropzone(dropZone, dropInputElement);\n\n    dropControl.on('drop', ({files}: any) => {\n      let url = '';\n\n      for (const file of (files as Map<string, File>).values()) {\n        url = URL.createObjectURL(file);\n        dropPreview.style.backgroundImage = `url(${url})`;\n        break;\n      }\n\n      context.worker.postMessage({action: 'change-texture', payload: url});\n    });\n  }\n}\n\n(self as any).demo = new ThreeDOMDemo();\n"]}